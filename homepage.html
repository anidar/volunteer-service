<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <title>Volunteer-Service App</title>

   <style>
      table, td {
         border: 1px solid black;
         text-align: center;
         border-collapse: collapse;
      }
   </style>

</head>
<body>
   <h1 id="id1">Welcome to the Volunteer-Service App!</h1>
   <button type="button"
           onclick=loadReviewersWithTable()> Click the button to show the current volunteers availability</button>
   <br><br>
   <p id="demo"></p>

   <table id="myTable">
   </table>
   <br><br>

   <h6> Add Frontend Volunteer: </h6>
   <input type="text" name="name" id='frontendName'>
   <button type="button"
              onclick=submitReviewer(document.getElementById('frontendName').value,'N','Y')> Submit </button>
   <br><br>

   <h6> Add Backend Volunteer: </h6>
   <input type="text" name="name" id='backendName'>
   <button type="button"
           onclick=submitReviewer(document.getElementById('backendName').value,'Y','N')> Submit </button>
   <br><br>

   <button type="button"
           onclick=loadReviewers()> Click the button to pick up reviewers</button>
   <br><br>

   <script>

      let volunteers = {};
      let pickedVolunteers = {};
      const tableCells = [0, 1, 2];


      function loadReviewersWithTable() {
         const xhttp = new XMLHttpRequest();
         xhttp.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
               volunteers = JSON.parse(this.responseText);
               createTable();
            }
         };
         xhttp.open("GET", "http://localhost:3000/api/user", true);
         xhttp.send();
      }


      function createTable() {
         const table = document.getElementById("myTable");
         const header = table.createTHead();
         const row = header.insertRow(0);
         const cell1 = row.insertCell(0);
         const cell2 = row.insertCell(1);
         const cell3 = row.insertCell(2);
         cell1.innerHTML = "<b>Frontend Volunteers</b>";
         cell2.innerHTML = "<b>Backend Volunteers</b>";
         //cell4.innerHTML = "<b>"+volunteers.users[0].name+"</b>";
         volunteers.users.forEach(fillVolunteerTable);
      }


      function fillVolunteerTable(volunteer, index, array) {
         const volunteerTable = document.getElementById('myTable');
         const row = volunteerTable.insertRow(index+1);
         const cellElements = tableCells.map( index => row.insertCell( index ) );
         if(array[index].frontend === 'Y'){
            cellElements[ 0 ].appendChild( document.createTextNode( array[ index ].name ) );
            var button = addRemoveButton();
            cellElements[2].appendChild(button);
         }
         if(array[index].backend === 'Y'){
            cellElements[ 1 ].appendChild( document.createTextNode( array[ index ].name ) );
            var button = addRemoveButton();
            cellElements[2].appendChild(button);
         }
         if((array[index].frontend === 'N') && (array[index].backend === 'N')){
            row.deleteCell(index);
         }
      }

      function addRemoveButton(  ) {
         var button = document.createElement("BUTTON");
         button.setAttribute('id', 'deleteButton');
         const deleteButtonText = document.createTextNode( 'remove' );
         button.appendChild(deleteButtonText);
         return button;
      }

      function submitReviewer( name, backendValue, frontendValue ){

         let flag = false;
         if(backendValue ==='Y'){
            flag = true;
         }

         const http = new XMLHttpRequest();
         let params = '{"users":[{"name":"'+ name +'","backend":"' + backendValue +'","frontend":"' + frontendValue +'"}]}';
         http.open("POST", "http://localhost:3000/api/user", true);
         http.setRequestHeader('Content-type', 'application/json');

         http.onreadystatechange = function() {//Call a function when the state changes.
            if(this.readyState === 4 && this.status === 200) {
               if(flag === true){
                  alert(name + " was added as a Backend Reviewer");
                  window.open("http://localhost:3000/");
               } else {
                  alert(name + " was added as a Frontend Reviewer");
                  window.open("http://localhost:3000/");
               }
            }
         }
         http.send(params);
      }


      function loadReviewers() {
         const xhttp = new XMLHttpRequest();
         xhttp.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
               volunteers = JSON.parse(this.responseText);
               loadPickedReviewers();
            }
         };
         xhttp.open("GET", "http://localhost:3000/api/user", true);
         xhttp.send();
      }

      function loadPickedReviewers(  ) {
         const http = new XMLHttpRequest();
         //loadReviewers();
         let params = '{"users":[';
         for(let i=0; i<volunteers.users.length; i++){
            params += '{"name":"' + volunteers.users[i].name+'","backend":"'+volunteers.users[i].backend+'","frontend":"'+volunteers.users[i].frontend+'"}';
            if(i!==(volunteers.users.length-1)){
               params += ',';
            }
         }
         params += ']}';

         //var params = '{"users":[{"name":"'+volunteers.users[0].name+'","backend":"'+volunteers.users[0].backend+'","frontend":"'+volunteers.users[0].frontend+'"},' + '{"name":"'+volunteers.users[1].name+'","backend":"'+volunteers.users[1].backend+'","frontend":"'+volunteers.users[1].frontend+'"},'+ '{"name":"'+volunteers.users[2].name+'","backend":"'+volunteers.users[2].backend+'","frontend":"'+volunteers.users[2].frontend+'"}]}';
         //var params = '{"users":[{"name":"RAN","backend":"Y","frontend":"N"},{"name":"FJA","backend":"N","frontend":"Y"},{"name":"AST","backend":"Y","frontend":"Y"},{"name":"RST","backend":"N","frontend":"Y"},{"name":"MNA","backend":"N","frontend":"Y"},{"name":"MMI","backend":"Y","frontend":"Y"},{"name":"KYA","backend":"N","frontend":"Y"},{"name":"TSA","backend":"Y","frontend":"N"}]}';
         http.open("POST", "http://localhost:3000/api/propose", true);
         http.setRequestHeader('Content-type', 'application/json');

         http.onreadystatechange = function() {//Call a function when the state changes.
            if(this.readyState === 4 && this.status === 200) {
               pickedVolunteers = JSON.parse(this.responseText);
               alert(pickedVolunteers.frontendReviewer + " is proposed as Frontend Reviewer\n"
                  + pickedVolunteers.backendReviewer +" is proposed as Backend Reviewer\n"
                  + pickedVolunteers.fallbackReviewer + " is proposed as Fallback Reviewer\n");
            }
         }
         http.send(params);
      }


   </script>
</body>
</html>

